# FLS - Alignment Drift Investigation

## Context

Integration tests compare Rust forced-alignment output against PyTorch reference
alignments generated by `scripts/pytorch_aligner.py`.

Target behavior: word timestamps should stay within configured delta.

## Initial Symptoms

- Integration test failed for all sampled utterances.
- Word text initially showed repeated letters (for example `YOUUU...`).
- After fixing repeated-letter handling, large timestamp drift remained.
- Example utterance: `4446-2273-0024` had strong mismatch against
  `test-data/alignments/test-clean.json`.

## Investigation Steps

1. Reproduced failure with CUDA integration test.
2. Added temporary grouping traces to check word reconstruction and separator
   flush decisions.
3. Confirmed first word was not actually cut by grouper logic; grouping was
   following the incoming path.
4. Added temporary runtime traces:
   - waveform stats (raw and normalized)
   - top-token runs across frames
   - Viterbi path state runs
5. Added temporary Python debug mode in `scripts/pytorch_aligner.py` for single
   utterance tracing (`4446-2273-0024`) to compare against Rust trace.
6. Compared Rust vs Python traces and found emissions divergence very early:
   PyTorch stayed `<pad>`-dominant in silence, Rust did not.

## Root Cause

Model parity bug in Rust encoder normalization strategy:

- Rust encoder layer was effectively using stable pre-norm behavior always.
- `wav2vec2-base-960h` config sets `do_stable_layer_norm=false`, which expects
  post-norm behavior.
- This mismatch distorted logits, warped Viterbi path progression, and produced
  large timestamp drift (including long state lock around `YOU`).

## Fix Applied

- Added `do_stable_layer_norm` to internal model config.
- Updated encoder layer forward pass to select:
  - pre-norm when `do_stable_layer_norm=true`
  - post-norm when `do_stable_layer_norm=false`
- Added GroupNorm parity support in the first conv layer for
  `feat_extract_norm="group"`.

## Verification

- Re-ran CUDA integration test:
  - `cargo test --features cuda pytorch_alignment_reference_matches_within_delta -- --nocapture`
  - Result: pass.
- Rust output for debug utterance aligned with expected reference timing shape.

## Cleanup

All temporary tracing/logging instrumentation used during debugging was removed
after confirmation.

